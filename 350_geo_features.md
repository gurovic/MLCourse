# **Feature Engineering –¥–ª—è –≥–µ–æ–¥–∞–Ω–Ω—ã—Ö: –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è, —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –∏ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏**  

## **–í–≤–µ–¥–µ–Ω–∏–µ –≤ —Ä–∞–±–æ—Ç—É —Å –≥–µ–æ–¥–∞–Ω–Ω—ã–º–∏**  
–ì–µ–æ–¥–∞–Ω–Ω—ã–µ ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω–æ–π –ø—Ä–∏–≤—è–∑–∫–æ–π (—à–∏—Ä–æ—Ç–∞/–¥–æ–ª–≥–æ—Ç–∞) ‚Äî –º–æ—â–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤:  
- üöï –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–æ–≤)  
- üè™ –†–∏—Ç–µ–π–ª–µ (–≤—ã–±–æ—Ä –ª–æ–∫–∞—Ü–∏–π –¥–ª—è –º–∞–≥–∞–∑–∏–Ω–æ–≤)  
- üå≥ –≠–∫–æ–ª–æ–≥–∏–∏ (–∞–Ω–∞–ª–∏–∑ –∑–æ–Ω –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏—è)  

**–û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ feature engineering:**  
- –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏  
- –í—ã—è–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–µ–π  
- –£—á–µ—Ç –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ –º–æ–¥–µ–ª—è—Ö ML  

---

## **üü¢ –ë–∞–∑–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å: –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç**  

### **1.1 –†–∞—Å—á–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–π**  
```python
from geopy.distance import geodesic

# –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏ (–≤ –∫–º)
def calculate_distance(lat1, lon1, lat2, lon2):
    return geodesic((lat1, lon1), (lat2, lon2)).km

# –ü—Ä–∏–º–µ—Ä: —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –ú–æ—Å–∫–≤–∞ - –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥
distance = calculate_distance(55.7558, 37.6173, 59.9343, 30.3351)
print(f"–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: {distance:.1f} –∫–º")  # ~635 –∫–º
```

### **1.2 –ì–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–¥—Ä–µ—Å–æ–≤**  
```python
from geopy.geocoders import Nominatim

def address_to_coords(address):
    geolocator = Nominatim(user_agent="geo_features")
    location = geolocator.geocode(address)
    return (location.latitude, location.longitude) if location else (None, None)

# –ü—Ä–∏–º–µ—Ä: –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ö—Ä–∞—Å–Ω–æ–π –ø–ª–æ—â–∞–¥–∏
lat, lon = address_to_coords("–ö—Ä–∞—Å–Ω–∞—è –ø–ª–æ—â–∞–¥—å, –ú–æ—Å–∫–≤–∞")
print(f"–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: {lat}, {lon}")  # 55.7539, 37.6208
```

### **1.3 –ë–∞–∑–æ–≤—ã–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏**  
```python
import pandas as pd

def add_basic_features(df, ref_point=(55.7558, 37.6173)):
    """–î–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–∏–∑–Ω–∞–∫–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π —Ç–æ—á–∫–∏"""
    df['distance_to_center'] = df.apply(
        lambda row: geodesic(ref_point, (row['lat'], row['lon'])).km, 
        axis=1
    )
    df['is_north'] = (df['lat'] > ref_point[0]).astype(int)
    return df
```

---

## **üü° –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π —É—Ä–æ–≤–µ–Ω—å: –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –∏ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∏**  

### **2.1 –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è —Ç–æ—á–µ–∫ DBSCAN**  
```python
from sklearn.cluster import DBSCAN
import numpy as np

def cluster_locations(coords, eps=0.01, min_samples=5):
    """–ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö —Ç–æ—á–µ–∫"""
    # eps –≤ –≥—Ä–∞–¥—É—Å–∞—Ö (~1.1 –∫–º –Ω–∞ —à–∏—Ä–æ—Ç–µ –ú–æ—Å–∫–≤—ã)
    coords_rad = np.radians(coords)  # –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–ª—è haversine
    clusterer = DBSCAN(
        eps=eps, 
        min_samples=min_samples, 
        metric='haversine'
    )
    labels = clusterer.fit_predict(coords_rad)
    return labels

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
coords = np.array([[55.7522, 37.6156], [55.7530, 37.6165], ...])
df['cluster_label'] = cluster_locations(coords)
```

### **2.2 –†–∞—Å—á–µ—Ç –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏ —Ç–æ—á–µ–∫**  
```python
from sklearn.neighbors import KernelDensity

def calculate_density(coords, radius=0.005):
    """–ü–ª–æ—Ç–Ω–æ—Å—Ç—å —Ç–æ—á–µ–∫ –≤ —Ä–∞–¥–∏—É—Å–µ (–≤ –≥—Ä–∞–¥—É—Å–∞—Ö)"""
    kde = KernelDensity(bandwidth=radius, metric='haversine')
    kde.fit(np.radians(coords))
    densities = np.exp(kde.score_samples(np.radians(coords)))
    return densities

df['point_density'] = calculate_density(coords)
```

### **2.3 –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –±–ª–∏–∂–∞–π—à–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞**  
```python
from sklearn.neighbors import BallTree

def distance_to_nearest(target_coords, reference_coords):
    """–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –±–ª–∏–∂–∞–π—à–µ–π —Ç–æ—á–∫–∏ –≤ reference_coords"""
    tree = BallTree(np.radians(reference_coords), metric='haversine')
    distances, _ = tree.query(np.radians(target_coords), k=1)
    return distances * 6371  # –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–∏–ª–æ–º–µ—Ç—Ä—ã

# –ü—Ä–∏–º–µ—Ä: —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –±–ª–∏–∂–∞–π—à–µ–π —Å—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ
df['dist_to_metro'] = distance_to_nearest(coords, metro_coords)
```

---

## **üî¥ –≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å: –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏ H3**  

### **3.1 –ì–µ–æ—à–µ—Å—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫–∏ H3 (Uber)**  
```python
import h3

def add_h3_features(df, resolution=9):
    """–î–æ–±–∞–≤–ª—è–µ—Ç H3-–∏–Ω–¥–µ–∫—Å—ã –∏ —Å–æ—Å–µ–¥–Ω–∏–µ —è—á–µ–π–∫–∏"""
    df['h3_index'] = df.apply(
        lambda row: h3.geo_to_h3(row['lat'], row['lon'], resolution), 
        axis=1
    )
    df['h3_neighbors'] = df['h3_index'].apply(
        lambda x: h3.k_ring(x, 1)  # —Å–æ—Å–µ–¥–∏ –ø–µ—Ä–≤–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞
    )
    return df
```

### **3.2 –ò–∑–æ—Ö—Ä–æ–Ω—ã –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏**  
```python
import osmnx as ox
from networkx import shortest_path_length

def calculate_isochrone(lat, lon, travel_time=15, speed=4.5):
    """–ó–æ–Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∑–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è (–ø–µ—à–∫–æ–º)"""
    G = ox.graph_from_point((lat, lon), network_type='walk', dist=2000)
    center_node = ox.distance.nearest_nodes(G, lon, lat)
    
    isochrone = set()
    for node in G.nodes:
        try:
            path_length = shortest_path_length(G, center_node, node, weight='length')
            if path_length <= travel_time * 60 * speed:  # –º–µ—Ç—Ä—ã
                isochrone.add(node)
        except:
            continue
    return isochrone
```

### **3.3 –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ (Moran's I)**  
```python
from libpysal.weights import DistanceBand
from esda.moran import Moran

def calculate_spatial_autocorrelation(values, coords):
    """–†–∞—Å—á–µ—Ç –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω–æ–π –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏"""
    w = DistanceBand(coords, threshold=0.02)  # –ø–æ—Ä–æ–≥ –≤ –≥—Ä–∞–¥—É—Å–∞—Ö
    moran = Moran(values, w)
    return moran.I

# –ü—Ä–∏–º–µ—Ä –¥–ª—è —Ü–µ–Ω –Ω–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å
autocorr = calculate_spatial_autocorrelation(df['price'], coords)
print(f"–ò–Ω–¥–µ–∫—Å –ú–æ—Ä–∞–Ω–∞: {autocorr:.3f}")
```

---

## **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∫–µ–π—Å—ã**  

### **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏—Å—Ç–∏–∫–∏**  
```python
# 1. –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –∑–∞–∫–∞–∑–æ–≤
# 2. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≤—ã–ø—É–∫–ª—ã—Ö –æ–±–æ–ª–æ—á–µ–∫ –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
# 3. –†–∞—Å—á–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
```

### **–ê–Ω–∞–ª–∏–∑ –≥–æ—Ä–æ–¥—Å–∫–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã**  
```python
# 1. –†–∞—Å—á–µ—Ç –∑–æ–Ω –ø–µ—à–µ—Ö–æ–¥–Ω–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ (–∏–∑–æ—Ö—Ä–æ–Ω—ã)
# 2. –í—ã—è–≤–ª–µ–Ω–∏–µ "–ø—É—Å—Ç—ã—à–µ–∫" - —Ä–∞–π–æ–Ω–æ–≤ –±–µ–∑ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
# 3. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏ –æ–±—ä–µ–∫—Ç–æ–≤ –≤ H3-—è—á–µ–π–∫–∞—Ö
```

---

## **–ó–∞–∫–ª—é—á–µ–Ω–∏–µ**  
**–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–±–æ—Ç—ã —Å –≥–µ–æ–¥–∞–Ω–Ω—ã–º–∏:**  
1. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ñ–µ—Ä–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏** (Haversine –≤–º–µ—Å—Ç–æ –ï–≤–∫–ª–∏–¥–∞)  
2. **–£—á–∏—Ç—ã–≤–∞–π—Ç–µ –º–∞—Å—à—Ç–∞–±** (–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∫–ª–∞—Å—Ç–µ—Ä–æ–≤/—è—á–µ–µ–∫)  
3. **–ö–æ–º–±–∏–Ω–∏—Ä—É–π—Ç–µ —Ç–µ—Ö–Ω–∏–∫–∏** (–∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è + –ø–ª–æ—Ç–Ω–æ—Å—Ç—å + –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏)  

**–ü–æ–ª–µ–∑–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**  
- `geopy` - –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ä–∞—Å—á–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–π  
- `h3-py` - –≥–µ–æ—à–µ—Å—Ç–∏—É–≥–æ–ª—å–Ω–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è  
- `osmnx` - —Ä–∞–±–æ—Ç–∞ —Å —É–ª–∏—á–Ω—ã–º–∏ —Å–µ—Ç—è–º–∏  
- `libpysal` - –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞  

> **"–ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ - —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ, –∞ –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–æ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º. –í–∞—à–∞ –∑–∞–¥–∞—á–∞ - —Å–¥–µ–ª–∞—Ç—å —ç—Ç–∏ —Å–∏—Å—Ç–µ–º—ã –ø–æ–Ω—è—Ç–Ω—ã–º–∏ –¥–ª—è –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤."**
